# æœåŠ¡å™¨é…ç½®è®°å½•

## ä¸€ã€èƒŒæ™¯ 

> çœŸå®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼šnginxã€tomcaté…ç½®httpsè¯ä¹¦

## äºŒã€nginx

### å®‰è£…è¿‡ç¨‹ï¼š

```shell
//ä¸€é”®å®‰è£…ä¸Šé¢å››ä¸ªä¾èµ–
yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel
//ä¸‹è½½taråŒ…
wget http://nginx.org/download/nginx-1.16.1.tar.gz
tar xzf nginx-1.16.1.tar.gz -C /usr/local
//æ–‡ä»¶åæ”¹nginx-1.16.1æˆnginx
//è¿›å…¥nginxç›®å½•
cd /usr/local/nginx
//å…³è”ç¼–è¯‘httpsæ¨¡å—
 ./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module
//æ‰§è¡Œmakeå‘½ä»¤ç¼–è¯‘æºç 
make
//æ‰§è¡Œmake installå®‰è£…å¯æ‰§è¡Œbin
make install
//æ–°å»ºlogsï¼ˆæ—¥å¿—ï¼‰å’Œsslï¼ˆè¯ä¹¦ï¼‰æ–‡ä»¶å¤¹
```

### httpsæµè§ˆå™¨å½±å“â€”â€”æ··åˆå†…å®¹

> è§£å†³Nginxåä»£Tomcat Httpã€Httpsæ··åˆå†…å®¹æŠ¥é”™ï¼Œæµè§ˆå™¨è®¤ä¸ºhttpsè¯·æ±‚ä¸­èµ„æºæ˜¯httpçš„cssã€jså’Œå›¾ç‰‡éƒ½æ— æ³•æ­£å¸¸åŠ è½½ï¼Œé€ æˆæ— æ³•åŒåè®®å…¼å®¹ï¼

```
æµè§ˆå™¨è®¿é—®åå¼€å‘è€…æ¨¡å¼çœ‹åˆ°çš„æŠ¥é”™ä¿¡æ¯ï¼š
Mixed Content: The page at 'https://dashboard.domain.com/wire' was loaded over HTTPS, but requested an insecure stylesheet 'http://dashboard.domain.com/static/css/flickity.css'. This request has been blocked; the content must be served over HTTPS.
```

### nginxè§£å†³é…ç½®

```json
user  www;
worker_processes  auto;

error_log  /var/log/nginx/error.log;

pid /run/nginx.pid;


events {
    worker_connections  51200;
    multi_accept on;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

	log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    tcp_nopush          on;
    tcp_nodelay         on;

    keepalive_timeout  65;
    types_hash_max_size 2048;

    #gzip  on;
	gzip on;
	
    server {
        listen       80;
        listen       443 ssl;
        server_name  chinaffxz.com;

        #charset koi8-r;
        
         ssl_certificate      /usr/local/nginx/ssl/2879444_chinagzhxy.com.pem;
         ssl_certificate_key  /usr/local/nginx/ssl/2879444_chinagzhxy.com.key;

        location / {
	    		proxy_pass http://127.0.0.1:xxxx/;
	    		proxy_redirect off;
        		proxy_set_header Host $host;
        		proxy_set_header X-Real-IP $remote_addr;
        		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    			#è§£å†³å…¼å®¹é…ç½®è¦ç‚¹
        		proxy_set_header X-Forwarded-Proto $scheme;
        		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}

```

### Tomcaté…ç½®

```xml
<?xml version="1.0" encoding="utf-8"?>
<Server port="8006" shutdown="SHUTDOWN">
    <Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />
    <Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />
    <Listener className="org.apache.catalina.core.ThreadLocalLeakPreventionListener" />
    <Listener className="org.apache.catalina.core.AprLifecycleListener" />
    <GlobalNamingResources>
        <Resource name="UserDatabase" auth="Container" type="org.apache.catalina.UserDatabase" description="User database that can be updated and saved" factory="org.apache.catalina.users.MemoryUserDatabaseFactory" pathname="conf/tomcat-users.xml" />
    </GlobalNamingResources>
    <Service name="Catalina">
        <Connector port="38080" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" maxThreads="1000" minSpareThreads="20" acceptCount="1000" maxHttpHeaderSize="65536" debug="0" disableUploadTimeout="true" useBodyEncodingForURI="true" enableLookups="false" URIEncoding="UTF-8" />
        <Engine name="Catalina" defaultHost="localhost">
         <!-- è§£å†³å…¼å®¹è¦ç‚¹-->  
         <Valve className="org.apache.catalina.valves.RemoteIpValve"  
		        remoteIpHeader="X-Forwarded-For"  
		        protocolHeader="X-Forwarded-Proto"  
		        protocolHeaderHttpsValue="https"/>
            <Realm className="org.apache.catalina.realm.LockOutRealm">
                <Realm className="org.apache.catalina.realm.UserDatabaseRealm" resourceName="UserDatabase" />
            </Realm>
            <Host name="localhost"  appBase="webapps" unpackWARs="true" autoDeploy="true">
		        <!-- Access log processes all example.
		             Documentation at: /docs/config/valve.html
		             Note: The pattern used is equivalent to using pattern="common" -->
		        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
		               prefix="localhost_access_log" suffix=".txt"
		               pattern="%h %l %u %t &quot;%r&quot; %s %b" />
			   <Context path="" docBase ="mall" debug="0" reloadable="true" crossContext="false"/>
		  </Host>
        </Engine>
    </Service>
</Server>

```



### gitæŒç»­éƒ¨ç½²shellè„šæœ¬

> è§£å†³Linux CentOSä¸­cp -f å¤åˆ¶å¼ºåˆ¶è¦†ç›–çš„å‘½ä»¤æ— æ•ˆçš„æ–¹æ³•ï¼Œç³»ç»Ÿé»˜è®¤ä½¿ç”¨cp -iä½¿ç”¨äº¤äº’æ–¹å¼é¿å…è¯¯æ“ä½œï¼Œä½†åœ¨è‡ªåŠ¨è„šæœ¬ä¸­åº”å½“é¿å…ï¼Œæ¨è**\cp**ã€‚

```shell
#update code
cd /root/dowload/mall/duoshanghu
git fetch origin 
git pull > /root/dowload/mall/logs/mall_git.log &
#package 
mvn package -Dmaven.test.skip=true
sleep 2s
#cp war to tomcat webapp
\cp -fr /root/dowload/mall/duoshanghu/target/mall.war /usr/local/env/tomcat/webapps/mall.war
sleep 1s
#restart.sh
sh /usr/local/env/tomcat/bin/restart.sh
```

### tomcaté‡å¯è„šæœ¬

```shell
#!/bin/sh
#åˆå§‹åŒ–å…¨å±€ç¯å¢ƒå˜é‡
. /etc/profile
#set java environment
export CLASSPATH=$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib

#æŸ¥æ‰¾tomcatçš„pid
pid=`ps aux | grep tomcat | grep -v grep | grep -v Restart | grep -v restart | awk '{print $2}'`
echo "the tomcat pid is $pid"

#åˆ¤æ–­tomcatè¿›ç¨‹æ˜¯å¦å­˜åœ¨
if [ -n "$pid" ];then
   sleep 1
   pid=`ps aux | grep tomcat | grep -v grep | grep -v restart | grep -v Restart | awk '{print $2}'`
   if [ -n "$pid" ]; then
      sleep 1
      echo "tomcatè¿›ç¨‹å°†è¢«æ€?"
      kill -9 $pid
   fi

   sleep 1

   echo "tomcatè¿›ç¨‹å·²ç»è¢«æ€æ­»ï¼Œå…ˆé‡æ–°å¯åŠ¨tomcat."
   service tomcat status
   sleep 1s
   service tomcat start
else
    echo "tomcatè¿›ç¨‹ä¸å­˜åœ¨ï¼Œå…ˆé‡æ–°å¯åŠ¨tomcat."
    service tomcat status
    sleep 1s
    service tomcat start
fi

```

### mavenç¼–è¯‘å®Œæ•´ä¾èµ–ç®¡ç†

#### 1ã€æ¥æº

> è§£å†³webapp/WEB-INF/libç›®å½•ä¸‹çš„jaråŒ…æ— æ³•ç”¨mavenæ‰“åŒ…ï¼Œä¸”åœ¨linuxMavenç¼–è¯‘æŠ¥é”™[ERROR] Fatal Error: Unable to find package java.lang in classpath or bootclasspathï¼Œè‡´å‘½é”™è¯¯: åœ¨ç±»è·¯å¾„æˆ–å¼•å¯¼ç±»è·¯å¾„ä¸­æ‰¾ä¸åˆ°ç¨‹åºåŒ… java.lang

#### 2ã€è§£å†³æ–¹æ³•

Linuxè§£å†³åŠæ³•ï¼Œä½¿ç”¨mavenè‡ªå¸¦çš„å˜é‡${path.separator}è·¯å¾„åˆ†éš”ç¬¦ï¼ŒåŸå› æ˜¯åœ¨Windowsä¸‹æ˜¯åˆ†å·;ï¼Œåœ¨linuxä¸‹æ˜¯å†’å·:

åŒæ—¶é…ç½®å¯¼å…¥webapp/WEB-INF/libå’Œjdkçš„rt.jarã€jce.jarï¼Œå®Œç¾è§£å†³ç¯å¢ƒé…ç½®å¸¦æ¥çš„æ— æ³•packageæ‰¾ä¸åˆ°ä¾èµ–é—®é¢˜ã€‚

#### pom.xmlï¼š

```xml
 <build>
        <finalName>${artifactId}</finalName>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                    <compilerArguments>
                        <verbose />                    <bootclasspath>${java.home}/lib/rt.jar${path.separator}${java.home}/lib/jce.jar</bootclasspath>
                        <extdirs>${basedir}/src/main/webapp/WEB-INF/lib</extdirs>
                    </compilerArguments>
                </configuration>
            </plugin>
        </plugins>
        <resources>
            <resource>
                <directory>src/main/resources</directory>
                <includes>
                    <include>**/*.*</include>
                </includes>
                <filtering>false</filtering>
            </resource>
            <resource>
                <directory>src/main/java</directory>
                <includes>
                    <include>**/*.properties</include>
                    <include>**/*.xml</include>
                </includes>
                <filtering>false</filtering>
            </resource>
        </resources>
    </build>
```

### å‚è€ƒ

[è§£å†³Nginxåä»£Tomcat Httpã€Httpsæ··åˆå†…å®¹æŠ¥é”™](https://spex.top/archives/nginx-tomcat-http-https.html)

[è§£å†³WEB-INF/libç›®å½•ä¸‹çš„jaråŒ…æ— æ³•ç”¨mavenæ‰“åŒ…](https://blog.csdn.net/u012204058/article/details/54974053)

### åé¦ˆä¸å»ºè®®

- å½“äº†ç»„é•¿é¢è¯•åŠ è¿ç»´ï¼Œå¯¹æ¥ä¸€å †æ”¯ä»˜å’Œç‰©æµã€çŸ­ä¿¡å’Œæ¨é€è´¦å·ï¼Œä»Šå¤©è®°å½•ä¸€ä¸‹é¢å‘DevOpsï¼
- markdownåŸæ–‡ä»¶åœ¨githubé‡Œé¢ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çœ‹å®˜starï¼Œé¢è¯•æˆ‘è¦å¾€è„¸ä¸Šè´´é‡‘å“ˆå“ˆå“ˆğŸ˜‚ã€‚
- é‚®ç®±ï¼š[caochikai@qq.com](mailto:caochikai@qq.com)ï¼Œæœ‰é—®é¢˜å‘é‚®ä»¶ã€‚