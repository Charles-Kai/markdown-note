---
title: åˆæ¢ç¼“å­˜
date: 2019-05-17 23:34:21
tags:
- spring
---

## å¤šçº§ç¼“å­˜æ¶æ„

### ç¼“å­˜è®¾è®¡ç†å¿µï¼š

>  ç¼“å­˜å¸¸ç”¨çš„å¯¹è±¡æˆ–è€…æ•°æ®ï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€æé«˜æ•ˆç‡ã€‚

### ç¼“å­˜å‘½ä¸­ç‡

> å³ä»ç¼“å­˜ä¸­è¯»å–æ•°æ®çš„æ¬¡æ•° ä¸ æ€»è¯»å–æ¬¡æ•°çš„æ¯”ç‡ï¼Œå‘½ä¸­ç‡è¶Šé«˜è¶Šå¥½ï¼š

### ç¼“å­˜ç­–ç•¥ï¼š

1. ç§»é™¤ç­–ç•¥ï¼šFIFOï¼ˆFirst In First Outï¼‰ï¼ŒLRUï¼ˆLeast Recently Usedï¼‰ï¼ŒLFUï¼ˆLeast Frequently Usedï¼‰ã€‚

2. TTLï¼ˆTime To Liveï¼‰ï¼šç¼“å­˜å­˜æ´»æœŸ

3. TTIï¼ˆTime To Idleï¼‰ï¼šç©ºé—²å­˜æ´»æœŸ

# spring cache

---

### ä¸€ã€æ¦‚å¿µ

> è‡ªSpring 3.1èµ·ï¼Œæä¾›æ³¨è§£ç¼“å­˜ï¼Œå¹¶ä¸”æä¾›äº‹åŠ¡å›æ»šæ—¶ä¹Ÿè‡ªåŠ¨å›æ»šç¼“å­˜ï¼Œå¹¶ä¸”æ”¯æŒSPELè¡¨è¾¾å¼ã€‚

### äºŒã€å…¥é—¨ä»£ç 

1ã€æ·»åŠ ä¾èµ–ï¼Œä¾‹å¦‚mavençš„pom.xml(Springboot);

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-cache</artifactId>
</dependency>
```

2ã€æ·»åŠ ä¸€ç§cacheManagerçš„beanå®ç°ç±»ï¼Œå¸¸è§ConcurrentMapCacheã€EhCacheCacheã€RedisCacheï¼›

```
    @Bean
    public CacheManager cacheManager() {
        SimpleCacheManager cacheManager = new SimpleCacheManager();
        cacheManager.setCaches(Collections.singletonList(new ConcurrentMapCache("models")));
        return cacheManager;
    }
```

3ã€é…ç½®æ¨¡å—åŠ è½½æ³¨è§£@EnableCaching

### ä¸‰ã€ä¸»è¦æ³¨è§£

1ã€@Cacheableï¼šå°†æ–¹æ³•è¿”å›å€¼ä½œä¸ºç¼“å­˜

- value (ä¹Ÿå¯ä½¿ç”¨ cacheNames) : å¯çœ‹åšå‘½åç©ºé—´ï¼Œè¡¨ç¤ºå­˜åˆ°å“ªä¸ªç¼“å­˜é‡Œäº†ã€‚

- key : è¡¨ç¤ºå‘½åç©ºé—´ä¸‹ç¼“å­˜å”¯ä¸€key,ä½¿ç”¨Spring Expression Language(ç®€ç§°SpEL,è¯¦è§å‚è€ƒæ–‡çŒ®[5])ç”Ÿæˆã€‚

- condition : è¡¨ç¤ºåœ¨å“ªç§æƒ…å†µä¸‹æ‰ç¼“å­˜ç»“æœ(å¯¹åº”çš„è¿˜æœ‰unless,å“ªç§æƒ…å†µä¸ç¼“å­˜),åŒæ ·ä½¿ç”¨SpEL

2ã€@CacheEvictï¼šåˆ é™¤ç¼“å­˜æ³¨è§£

3ã€@CachePutï¼šåˆ·æ–°æ³¨è§£

# ehcache

---

### ä¸€ã€æ¦‚å¿µ

### äºŒã€å…¥é—¨ä»£ç 

1ã€ç¼“å­˜åˆ†ç»„ï¼Œè¦å¯¹åˆ†ç»„è¿›è¡Œå…¨æ–°CacheConfiguration ï¼Œä¸ºäº†é«˜æ•ˆä½¿ç”¨é…ç½®è‡ªå®šä¹‰å±æ€§æå–å™¨ã€‚é»˜è®¤çš„å±æ€§å¤„ç†å™¨æ˜¯JavaBeanAttributeExtractorã€‚

```
@Bean
    public EhCacheGroupBeanPostProcessor addCache() {
        System.out.println(".......æ·»åŠ ç¼“å­˜ç»„........");
        return new EhCacheGroupBeanPostProcessor();
    }
        //åç½®å¤„ç†å™¨
    public static class EhCacheGroupBeanPostProcessor implements BeanPostProcessor {
        @Override
        public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
                      //æ ¹æ®å‰é¢åˆå§‹åŒ–å®Œæˆçš„beanNameè¿›ä¸€æ­¥æ“ä½œ
           if(beanName.equals("appEhCacheCacheManager") ) {
                EhCacheCacheManager manager = (EhCacheCacheManager)bean;
                CacheManager cacheManager = manager.getCacheManager();
//              æ–‡ç« ç¼“å­˜å‘½ä¸­é…ç½®needUpdate
                CacheConfiguration configuration = new CacheConfiguration(ReadCacheNames.æ–‡ç« ç¼“å­˜,10000);
                Searchable searchable = new Searchable();
                searchable.setKeys(false);
                searchable.setValues(false);
                                //åŠ¨æ€ç´¢å¼•
                searchable.setAllowDynamicIndexing(true);
                searchable.addSearchAttribute(new SearchAttribute().name("needUpdate").className("com.dwalk.social.common.util.ArticlesAttributeExtractor"));
                configuration.eternal(true).addSearchable(searchable);
                Cache articlesCache = new Cache(configuration);
                cacheManager.addCache(articlesCache);
                cacheManager.addCache(ReadCacheNames.çƒ­ç‚¹æ–‡ç« ç¼“å­˜);
            }
            return bean;
        }

    }
```

2ã€ä½¿ç”¨springå†…ç½®å®šæ—¶å™¨ï¼Œå¹¶ä½¿ç”¨ehcacheæŸ¥è¯¢apiè¿›è¡Œç¼“å­˜æŸ¥è¯¢ã€‚

```
        @Scheduled(cron = "0 0/1 * * * ?")
    private void synchronize() {
        Cache cache = cacheManager.getCache(ReadCacheNames.æ–‡ç« ç¼“å­˜);
        int size = cache.getSize();
        if (size > 0) {
            Query query = cache.createQuery();
            Attribute searchAttribute = cache.getSearchAttribute("needUpdate");
                        //æŒ‡å®šæŸ¥è¯¢çš„
            query.includeAttribute(searchAttribute);
            query.includeValues();
            Results execute = query.addCriteria(searchAttribute.eq(true)).execute();
            List all = execute.all();
            log.info("æŸ¥è¯¢æ–‡ç« ç¼“å­˜çš„å¤§å°ï¼š{}", all.size());
            for (Result result : all) {
                ArticlesDTO articles = (ArticlesDTO) result.getValue();
                articles.setNeedUpdate(false);
                Articles target = new Articles();
//              åŒæ­¥æµè§ˆé‡ã€è§†é¢‘æ’­æ”¾é‡ã€è¯„è®ºæ•°ã€ç‚¹èµæ•°ã€æ”¶è—æ•°
                target.setVisitorNum(articles.getVisitorNum()).setCommentNum(articles.getCommentNum()).
                        setPlayNum(articles.getPlayNum()).setLikeNum(articles.getLikeNum()).setCollectNum(articles.getCollectNum());
                articlesService.updateById(target);
            }
        }
    }
```

### ä¸‰ã€æ€»ç»“

1ã€éœ€è¦ç†Ÿæ‚‰springæ¥å£è®¾è®¡ï¼Œä»¥æ¥å£ä½¿ç”¨æ¡†æ¶ï¼Œè¦ä¸ç„¶å®˜æ–¹apiä½¿ç”¨éœ€äº†è§£è¯¸å¤šç»†èŠ‚ã€‚

### å››ã€ä¸€äºŒçº§ç¼“å­˜

> å½“é‡åˆ°@Cacheableè¿”å›ä¸ºnullè®°å½•ï¼Œä¸ºäº†æˆåŠŸåºåˆ—åŒ–nullï¼Œä½¿ç”¨äº†org.springframework.cache.support.NullValueå¯¹è±¡ä»£æ›¿nullã€‚

```
com.alibaba.fastjson.JSONException: autoType is not support. org.springframework.cache.support.NullValue
1ã€èµ·æºä¸€äºŒçº§ç¼“å­˜é‡å†™get()æ–¹æ³•
public class EhRedisCache extends AbstractValueAdaptingCache {
            éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦
        @Override
    public  T get(Object key, Callable valueLoader) {
                    try {
                lock.lock();
                value = lookup(key);
                if(value != null) {
                    return (T) value;
                }
                value = valueLoader.call();
                        //toStoreValueæ˜¯AbstractValueAdaptingCacheæŠ½è±¡ç±»çš„æ–¹æ³•
                Object storeValue = toStoreValue(value);
                put(key, storeValue);
                return (T) value;
            } catch (Exception e) {
                throw new ValueRetrievalException(key, valueLoader, e.getCause());
            } finally {
                lock.unlock();
            }
        }
}
2ã€toStoreValueåˆ¤æ–­userValue == null åˆ™return NullValue.INSTANCE 
-> public static final Object INSTANCE = new NullValue();

public abstract class AbstractValueAdaptingCache implements Cache {
    protected Object toStoreValue(@Nullable Object userValue) {
        if (userValue == null) {
            if (this.allowNullValues) {
                return NullValue.INSTANCE;
            }
            throw new IllegalArgumentException(
                    "Cache '" + getName() + "' is configured to not allow null values but null was provided");
        }
        return userValue;
    }
}
3ã€åºåˆ—åŒ–ååºåˆ—åŒ–
public class FastJsonRedisSerializer implements RedisSerializer {
        @Override
    public T deserialize(byte[] bytes) throws SerializationException {
        if (null == bytes || bytes.length <= 0) {
            return null;
        }
        String str = new String(bytes, DEFAULT_CHARSET);
        return (T) JSON.parseObject(str, clazz);
    }

}
4ã€jsonParserè§£æç±»å‹
public class com.alibaba.fastjson.parser.DefaultJSONParser implements Closeable {
    public final Object parseObject(final Map object, Object fieldName) {
                    éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦
                                            Class clazz = null;
                        if (object != null
                                && object.getClass().getName().equals(typeName)) {
                            clazz = object.getClass();
                        } else {
            //com.alibaba.fastjson.parser.DefaultJSONParser#configæ‰§è¡Œ
                            clazz = config.checkAutoType(typeName, null, lexer.getFeatures());
                        }
    }
}
5ã€å¼‚å¸¸æŠ›å‡ºç‚¹TypeUtils.getClassFromMapping(typeName) -ã€‹ typeNameä¸ºorg.springframework.cache.support.NullValue
public Class checkAutoType(String typeName, Class expectClass, int features) {
    if (Arrays.binarySearch(denyHashCodes, hash) >= 0 && TypeUtils.getClassFromMapping(typeName) == null) {
                        throw new JSONException("autoType is not support. " + typeName);
    }
}
6ã€TypeUtilsçš„getClassFromMappingæ–¹æ³•è¿”å›null
        public static Class getClassFromMapping(String className){
        return mappings.get(className);
    }
7ã€TypeUtilsä¸æ”¯æŒorg.springframework.cache.support.NullValue
private static ConcurrentMap> mappings = new ConcurrentHashMap>(16, 0.75f, 1);
//mappingsç±»å‹ç™½åå•
private static void addBaseClassMappings(){
        mappings.put("byte", byte.class);
        mappings.put("short", short.class);
        mappings.put("int", int.class);
        mappings.put("long", long.class);
        mappings.put("float", float.class);
        mappings.put("double", double.class);
        mappings.put("boolean", boolean.class);
                éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦
                fastJsonå®˜æ–¹æ²¡æœ‰æ”¯æŒorg.springframework.cache.support.NullValue
}
```

## åé¦ˆä¸å»ºè®®

- ä»Šå¤©å¤å‡ºå†™åšå®¢ï¼Œä¸€æ˜¯æ„Ÿè§‰æ‡’äº†æœŸæœ›è¿›æ­¥ï¼ŒäºŒæ˜¯ä¸ºäº†ç§¯ç´¯çŸ¥è¯†æ–¹ä¾¿copyğŸ˜‚ã€‚
- é‚®ç®±ï¼š<caochikai@qq.com>
